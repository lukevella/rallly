name: CI
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  type-check:
    name: Type check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node
      - uses: ./.github/actions/pnpm-install

      - name: Generate Prisma Client
        run: pnpm db:generate

      - name: Check types
        run: pnpm type-check

  sherif:
    name: Sherif
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node

      - name: Run sherif
        run: pnpm dlx sherif@latest

  linting:
    name: Linting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node
      - uses: ./.github/actions/pnpm-install

      - name: Check linting rules
        run: pnpm turbo check

  unit-tests:
    name: Unit tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node
      - uses: ./.github/actions/pnpm-install

      - name: Generate Prisma Client
        run: pnpm db:generate

      - name: Run tests
        run: pnpm test:unit

  docker-smoke-test:
    name: Docker smoke test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -f apps/web/Dockerfile -t rallly-test --build-arg SELF_HOSTED=true .

      - name: Start Postgres
        run: |
          docker run -d --name rallly-db \
            -e POSTGRES_PASSWORD=postgres \
            -e POSTGRES_DB=rallly \
            -p 5450:5432 \
            postgres:14.2
          until docker exec rallly-db pg_isready -U postgres; do sleep 1; done

      - name: Start container
        run: |
          docker run -d --name rallly-test \
            -e DATABASE_URL=postgresql://postgres:postgres@host.docker.internal:5450/rallly \
            -e SECRET_PASSWORD=test-secret \
            -e NEXT_PUBLIC_BASE_URL=http://localhost:3000 \
            -p 3000:3000 \
            --add-host=host.docker.internal:host-gateway \
            rallly-test

      - name: Wait for healthy
        run: |
          for i in $(seq 1 30); do
            if curl -sf http://localhost:3000/api/status; then exit 0; fi
            sleep 2
          done
          echo "Container failed to become healthy. Logs:"
          docker logs rallly-test
          exit 1

  integration-tests:
    name: Integration tests
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5450/rallly
      DIRECT_DATABASE_URL: postgresql://postgres:postgres@localhost:5450/rallly
      CI: true
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node
      - uses: ./.github/actions/pnpm-install

      - name: Generate Prisma Client
        run: pnpm db:generate

      - name: Install system dependencies
        run: sudo apt-get update

      - name: Install playwright dependencies
        run: pnpm playwright install --with-deps chromium

      - name: Create production build
        run: pnpm turbo build:test --filter=@rallly/web

      - name: Start services
        run: pnpm docker:up

      - name: Setup database
        run: pnpm db:deploy

      - name: Run tests
        run: pnpm turbo test:integration

      - name: Upload artifact playwright-report
        if: ${{ success() || failure() }}
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: ./apps/web/playwright-report
